---
title: "Лабораторна робота № 5. Дисперсійний аналіз (ANOVA)"
author: "Процко Поліна"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    code-fold: show
    self-contained: true
editor: visual
bibliography: references.bib
lang: uk
---

## 1. Постановка завдання

**Мета роботи:** Продемонструвати сутність однофакторного дисперсійного аналізу під час обробки експериментальних даних, набути навичок практичного застосування однофакторного дисперсійного аналізу [@sydorenko2023didactic; @manual2023].

**Індивідуальне завдання:** Маємо групи значень випадкової величини $X$ для кожного рівня фактора. Необхідно для заданих вибірок (варіант: `Col_4` та `Col_29`) перевірити нульову гіпотезу про рівність математичних сподівань:

$$H_0: M(X_1) = M(X_2)$$

Альтернативна гіпотеза: $$H_1: M(X_1) \neq M(X_2)$$

Рівень надійності $\gamma = 0,95$ ($\alpha = 0,05$).

**Етапи виконання:**

1.  Перевірити нормальність розподілу $X$ на кожному рівні.
2.  Перевірити однорідність дисперсій (критерій Бартлетта).
3.  Виконати дисперсійний аналіз (ANOVA).
4.  Побудувати графік інтервальних оцінок середніх.

------------------------------------------------------------------------

## 2. Короткі теоретичні відомості

Дисперсійний аналіз (**ANOVA**) — це метод перевірки гіпотез про рівність середніх значень кількох генеральних сукупностей шляхом порівняння дисперсій [@sydorenko2022opt].

Лінійна модель однофакторного аналізу має вигляд: $$x_{ij} = \mu + \alpha_j + \epsilon_{ij},$$ де $\mu$ — загальне середнє, $\alpha_j$ — ефект впливу фактора, $\epsilon_{ij}$ — випадкова похибка ($\epsilon_{ij} \sim N(0, \sigma^2)$) [@manual2023].

Загальна сума квадратів відхилень розкладається на дві компоненти: $$S_{zag} = S_{fact} + S_{zal}$$ де $S_{fact}$ — факторна дисперсія (міжгрупова), а $S_{zal}$ — залишкова (внутрішньогрупова).

Рішення приймається на основі **F-критерію Фішера**. Якщо розраховане P-значення менше за рівень значущості $\alpha$ ($p < 0.05$), нульова гіпотеза про рівність середніх відхиляється.

------------------------------------------------------------------------

## 3. Хід виконання лабораторної роботи

### 3.1 Імпорт та підготовка даних

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
library(knitr)
library(broom)
library(readxl)

# Назва файлу даних
file_name <- "Варианты1-17.xls"

# --- БЛОК ІМІТАЦІЇ ДАНИХ (Якщо файл відсутній) ---
if(!file.exists(file_name)) {
  stop("Файл не знайдено! Переконайтесь, що 'Варианты1-17.xls' у папці проєкту.")
}

# Зчитування даних
raw_data <- suppressMessages(read_excel(file_name, sheet = 1))

# Перейменування колонок для уніфікації (Col_1, Col_2...)
# Це виправляє проблему, якщо в Excel назви колонок були цифрами
colnames(raw_data) <- paste0("Col_", 1:ncol(raw_data))

# Формування робочого датафрейму (Long format)
df_anova <- raw_data %>%
  select(Col_4, Col_29) %>%       
  pivot_longer(cols = everything(), 
               names_to = "Group", 
               values_to = "Value") %>%
  filter(!is.na(Value)) 

# Конвертація групи у фактор
df_anova$Group <- as.factor(df_anova$Group)

# Виведення фрагмента
head(df_anova) %>% kable(caption = "Фрагмент підготовлених даних")

# Описова статистика
stats <- df_anova %>%
  group_by(Group) %>%
  summarise(
    N = n(),
    Mean = mean(Value),
    SD = sd(Value),
    Median = median(Value)
  )
kable(stats, caption = "Описова статистика", digits = 3)
```

### 3.2 Перевірка нормальності розподілу

Перевірка здійснюється за критерієм Шапіро-Вілка ($H_0$: розподіл нормальний).

```{r}
#| label: normality-test

norm_test <- df_anova %>%
  group_by(Group) %>%
  summarise(
    W = shapiro.test(Value)$statistic,
    p.value = shapiro.test(Value)$p.value,
    Distribution = ifelse(p.value > 0.05, "Нормальний", "Не нормальний")
  )

kable(norm_test, caption = "Результати тесту Шапіро-Вілка", digits = 4)
```

### 3.3 Перевірка однорідності дисперсій

Використовуємо критерій Бартлетта ($H_0$: дисперсії рівні).

```{r}
#| label: bartlett-test

bartlett_res <- bartlett.test(Value ~ Group, data = df_anova)
print(bartlett_res)
```

**Результат:** P-value тесту Бартлетта дорівнює `r format.pval(bartlett_res$p.value, eps = .001)`. Якщо це значення $< 0.05$, то дисперсії неоднорідні.

### 3.4 Дисперсійний аналіз (ANOVA)

Проводимо класичний однофакторний ANOVA.

```{r}
#| label: anova-calc

anova_model <- aov(Value ~ Group, data = df_anova)

# Використовуємо tidy() для гарного форматування таблиці
tidy(anova_model) %>% kable(caption = "Таблиця дисперсійного аналізу", digits = 4)
```

Додатково: Якщо умови нормальності порушені (див. п. 3.2), доцільно перевірити результати непараметричним тестом Крускала-Уолліса:

```{r}
#| label: kruskal-test
kruskal.test(Value ~ Group, data = df_anova)
```

### 3.5 Графічна візуалізація

Побудуємо графік середніх значень з 95% довірчими інтервалами та комбіновану діаграму розмаху.

```{r}
#| label: plot-means
#| fig-cap: "Інтервальні оцінки математичних сподівань"

# Розрахунок статистики для графіка
plot_data <- df_anova %>%
  group_by(Group) %>%
  summarise(
    Mean = mean(Value),
    SD = sd(Value),
    N = n(),
    SE = SD / sqrt(N),
    CI_Lower = Mean - qt(0.975, df = N-1) * SE,
    CI_Upper = Mean + qt(0.975, df = N-1) * SE
  )

# Графік 1: Інтервальні оцінки
ggplot(plot_data, aes(x = Group, y = Mean)) +
  geom_point(size = 4, color = "darkblue") +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), 
                width = 0.2, color = "darkblue", linewidth = 1) +
  labs(
    title = "Графік середніх значень (Mean Plot)",
    subtitle = "Вуса позначають 95% довірчий інтервал",
    x = "Група",
    y = "Середнє значення"
  ) +
  theme_minimal()
```

```{r}
#| label: plot-boxplot
#| fig-cap: "Діаграма розмаху з накладанням даних"

# Графік 2: Boxplot + Jitter
ggplot(df_anova, aes(x = Group, y = Value, fill = Group)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6, color = "darkgrey") +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "red") +
  labs(
    title = "Розподіл значень у групах",
    subtitle = "Червоний ромб — середнє значення",
    x = "Група",
    y = "Значення"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

------------------------------------------------------------------------

## 4. Висновки

У ході лабораторної роботи було проведено дисперсійний аналіз для двох вибірок (`Col_4` та `Col_29`).

1.  **Перевірка нормальності:** Тест Шапіро-Вілка показав, що p-значення для груп становлять `r paste(format.pval(norm_test$p.value, eps=0.001), collapse=" та ")`.

    -   *Інтерпретація:* Якщо $p > 0.05$, розподіл узгоджується з нормальним.

2.  **Перевірка однорідності дисперсій:** Тест Бартлетта дав результат $p =$ `r format.pval(bartlett_res$p.value, eps=0.001)`.

    -   *Інтерпретація:* Якщо $p < 0.05$, дисперсії є неоднорідними.

3.  **Результати порівняння:** ANOVA (F-тест) показав p-значення: `r format.pval(summary(anova_model)[[1]][["Pr(>F)"]][1], eps=0.001)`.

    **Загальний висновок:** Оскільки розраховане p-значення `r ifelse(summary(anova_model)[[1]][["Pr(>F)"]][1] < 0.05, "менше", "більше")` за рівень значущості $\alpha=0.05$, ми `r ifelse(summary(anova_model)[[1]][["Pr(>F)"]][1] < 0.05, "відхиляємо", "приймаємо")` нульову гіпотезу. Між групами `Col_4` та `Col_29` `r ifelse(summary(anova_model)[[1]][["Pr(>F)"]][1] < 0.05, "існує статистично значуща відмінність", "статистично значущої відмінності не виявлено")` у середніх значеннях.

------------------------------------------------------------------------

## Перелік посилань

::: {#refs}
:::
